<!DOCTYPE html>
<html>
<head>
    <title>Cookie Test</title>
</head>
<body>
    <h1>Cookie Cross-Origin Test</h1>
    <button onclick="testLogin()">Test Login</button>
    <button onclick="testLoginWithWrongCredentials()">Test Login (Wrong Password)</button>
    <button onclick="testLoginWithoutRequiredFields()">Test Login (Missing Fields)</button>
    <button onclick="testUpdateUserIndonesian()">Test Update User (Indonesian)</button>
    <button onclick="testUpdateUserEnglish()">Test Update User (English)</button>
    <button onclick="testPrivate()">Test Private Endpoint (Cookie)</button>
    <button onclick="testPrivateWithHeader()">Test Private Endpoint (Header)</button>
    <button onclick="checkCookies()">Check Cookies</button>
    <button onclick="clearStorage()">Clear Storage</button>
    
    <div id="results"></div>

    <script>
        const BASE_URL = 'http://192.168.1.6:4000/api';
        
        async function testLogin() {
            try {
                const response = await fetch(`${BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include', // CRUCIAL!
                    body: JSON.stringify({
                        email: 'admin@gmail.com',
                        password: 'admin123',
                        remember_me: false,
                        recaptcha_token: 'test-token'
                    })
                });
                
                const data = await response.json();
                
                // Save token for header authentication test
                if (data.data && data.data.token) {
                    localStorage.setItem('authToken', data.data.token);
                    console.log('Token saved to localStorage:', data.data.token);
                }
                
                document.getElementById('results').innerHTML = 
                    `<h3>Login Response:</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                console.log('Response headers:', response.headers);
                console.log('Set-Cookie header:', response.headers.get('Set-Cookie'));
                
            } catch (error) {
                document.getElementById('results').innerHTML = 
                    `<h3>Login Error:</h3><pre>${error.message}</pre>`;
            }
        }
        
        async function testLoginWithWrongCredentials() {
            try {
                const response = await fetch(`${BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept-Language': 'id' // Test Indonesian translation
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: 'admin@gmail.com',
                        password: 'wrongpassword', // Wrong password to trigger user.cannot_login
                        remember_me: false,
                        recaptcha_token: 'test-token'
                    })
                });
                
                const data = await response.json();
                document.getElementById('results').innerHTML += 
                    `<h3>Login With Wrong Credentials Response (Indonesian):</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
                
            } catch (error) {
                document.getElementById('results').innerHTML += 
                    `<h3>Login Error:</h3><pre>${error.message}</pre>`;
            }
        }

        async function testLoginWithoutRequiredFields() {
            try {
                const response = await fetch(`${BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: 'admin@gmail.com',
                        password: 'admin123'
                        // Missing remember_me and recaptcha_token
                    })
                });
                
                const data = await response.json();
                document.getElementById('results').innerHTML += 
                    `<h3>Login Without Required Fields Response:</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
                
            } catch (error) {
                document.getElementById('results').innerHTML += 
                    `<h3>Login Error:</h3><pre>${error.message}</pre>`;
            }
        }
        
        async function testPrivate() {
            try {
                const response = await fetch(`${BASE_URL}/private/users`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include' // CRUCIAL!
                });
                
                const data = await response.json();
                document.getElementById('results').innerHTML += 
                    `<h3>Private Endpoint Response (Cookie):</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
                    
            } catch (error) {
                document.getElementById('results').innerHTML += 
                    `<h3>Private Error (Cookie):</h3><pre>${error.message}</pre>`;
            }
        }
        
        async function testPrivateWithHeader() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    document.getElementById('results').innerHTML += 
                        `<h3>Header Test Error:</h3><pre>No token found. Please login first.</pre>`;
                    return;
                }
                
                const response = await fetch(`${BASE_URL}/private/users`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                document.getElementById('results').innerHTML += 
                    `<h3>Private Endpoint Response (Header):</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
                    
            } catch (error) {
                document.getElementById('results').innerHTML += 
                    `<h3>Private Error (Header):</h3><pre>${error.message}</pre>`;
            }
        }
        
        function checkCookies() {
            const cookies = document.cookie;
            const token = localStorage.getItem('authToken');
            document.getElementById('results').innerHTML += 
                `<h3>Current Cookies:</h3><pre>${cookies || 'No cookies found'}</pre>
                 <h3>LocalStorage Token:</h3><pre>${token || 'No token found'}</pre>`;
        }
        
        function clearStorage() {
            localStorage.removeItem('authToken');
            document.getElementById('results').innerHTML += 
                `<h3>Storage Cleared</h3>`;
        }
    </script>
</body>
</html>
